<!DOCTYPE html>
<!-- saved from url=(0035)http://127.0.0.1:5500/frontend.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>DB Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f5;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 80%;
            height: 70%;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #4a77f7;
            padding: 16px;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .chat-box {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f7f9fc;
        }

        .msg {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.4;
            font-size: 14px;
        }

        .user-msg {
            background: #4a77f7;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .bot-msg {
            background: #e5e7eb;
            color: #111;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            display: flex;
            border-top: 1px solid #ddd;
        }

        input {
            flex: 1;
            padding: 12px;
            border: none;
            outline: none;
            font-size: 15px;
        }

        button {
            padding: 0 18px;
            background: #4a77f7;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #3b63d6;
        }

        .request-block {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="chat-container">
        <style>
            .chat-header {
                background-color: #4a77f7;
                color: #ffffff;
                padding: 12px 20px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 18px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                display: inline-block;
            }
            
            .chat-header .assistant-name {
                color: #f48a26; /* Highlight color for DB Assistant */
                font-weight: bold;
                font-size: 20px;
                margin-right: 6px;
            }
            </style>
            
            <div class="chat-header">
                <span class="assistant-name">DB Assistant</span> - Remember, even humans make mistakes !
            </div>
            

        <div class="chat-box" id="chatBox"><div class="request-block"><div class="msg user-msg">give me top 5 agent insights having high risk</div><div class="msg bot-msg"><b>Agent Steps:</b><br><div>
                            <div><b>ðŸ”§ Step 1 â€” Calling tool: bigquery_list_tables</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{}</pre>
                            </details>

                            <div id="tool-output-ba478296a00742cf908bcc3ecd8380a0">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>agent_insights: No description available.
available_columns: No description available.
catalog: No description available.
data_dictionary: No description available.
dim_employees: No description available.
dlp_findings: No description available.
dlp_summary: No description available.
dlpwork: No description available.
fact_assets: No description available.
insight_computation: No description available.
insights: No description available.
insights_computation: No description available.
intune_assets: Intune Asset Inventory snapshot of devices managed via MDM. 
itglue_assets: IT Glue Asset Inventory snapshot of Apple devices (macOS, iOS/iPadOS, tvOS) managed via MDM. 
itglue_consumables: Inventory of IT Glue consumables (e.g., toner, cables, peripherals) with vendor/PO details, cost/quantity.
metadata_summary: No description available.
missed_insights: No description available.
mosyle_assets: Mosyle Asset Inventory snapshot of Apple devices (macOS, iOS/iPadOS, tvOS) managed via MDM.
profiling: No description available.
profiling_summary: No description available.
quality: No description available.
quality_summary: No description available.
workday_employees: Employee snapshot dataset, one row per employee.</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 2 â€” Calling tool: bigquery_get_schema</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "table_names": [
    "agent_insights"
  ]
}</pre>
                            </details>

                            <div id="tool-output-496a6ac0fd7446fda2ddfa18b3a87ae2">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>
Table: agent_insights
Schema:
insight_id (STRING) - No description available.
insight_title (STRING) - No description available.
description (STRING) - No description available.
table_name (STRING) - No description available.
required_columns (STRING) - No description available.
insight_type (STRING) - No description available.
insight_src (STRING) - No description available.
data_source_type (STRING) - No description available.
rendered_sql (STRING) - No description available.
is_insight_possible (BOOLEAN) - No description available.
ingestion_timestamp (TIMESTAMP) - No description available.
ingestion_date (DATE) - No description available.
is_reviewed (BOOLEAN) - No description available.

Sample Rows:
[{'insight_id': 'c244f08c-1590-4d4d-ac02-f3795d0903a4', 'insight_title': 'Premature Purchasing Wastes Asset Warranty Periods', 'description': 'IT consumables are being put into service for new employees more than 30 days before their actual hire date. This practice ties up capital, prematurely starts the warranty clock, and erodes the value of the asset before it is ever used. This indicates a misalignment between the IT procurement process and final HR onboarding timelines, leading to inefficient use of resources and reduced asset lifecycle value.', 'table_name': 'workday_employees, itglue_consumables', 'required_columns': 'itglue_consumables.in_service_date, workday_employees.hire_date, itglue_consumables.user_name', 'insight_type': 'Cost Saving', 'insight_src': 'planning_agent', 'data_source_type': 'bigquery', 'rendered_sql': '', 'is_insight_possible': False, 'ingestion_timestamp': datetime.datetime(2025, 11, 20, 11, 21, 4, 739627, tzinfo=datetime.timezone.utc), 'ingestion_date': datetime.date(2025, 11, 20), 'is_reviewed': False}, {'insight_id': '7b05fea6-72d1-412d-b030-38ada3a05d18', 'insight_title': 'Departments Driving High Non-Compliance Cost Risk', 'description': "The Finance department accounts for over 40% of all corporate-owned devices that are in a 'Non-Compliant' state. This concentration of non-compliance creates significant financial risk from potential regulatory fines and security breaches, requiring targeted remediation.", 'table_name': 'intune_assets, workday_employees', 'required_columns': 'intune_assets.compliance_state, intune_assets.ownership_type, intune_assets.user_principal_name, workday_employees.cost_center_name', 'insight_type': 'Cost Saving', 'insight_src': 'planning_agent', 'data_source_type': 'bigquery', 'rendered_sql': '', 'is_insight_possible': False, 'ingestion_timestamp': datetime.datetime(2025, 11, 18, 11, 18, 37, 942325, tzinfo=datetime.timezone.utc), 'ingestion_date': datetime.date(2025, 11, 18), 'is_reviewed': False}, {'insight_id': 'eed972f3-65c2-4cd5-bf45-01c67d6522fb', 'insight_title': 'Untracked Consumables Missing Associated Hardware', 'description': 'Purchase orders for consumables totaling over $5,000 have no corresponding hardware asset record in the inventory. This process gap means peripherals are being purchased without being linked to a primary device, leading to untraceable spend and likely asset loss.', 'table_name': 'itglue_consumables, itglue_assets', 'required_columns': 'itglue_consumables.purchase_order, itglue_consumables.unit_cost, itglue_consumables.quantity, itglue_assets.purchase_order', 'insight_type': 'Cost Saving', 'insight_src': 'planning_agent', 'data_source_type': 'bigquery', 'rendered_sql': '', 'is_insight_possible': False, 'ingestion_timestamp': datetime.datetime(2025, 11, 18, 11, 18, 37, 942325, tzinfo=datetime.timezone.utc), 'ingestion_date': datetime.date(2025, 11, 18), 'is_reviewed': False}]</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 3 â€” Calling tool: bq_unified_query_checker</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "SELECT DISTINCT insight_type FROM `agent_insights`"
}</pre>
                            </details>

                            <div id="tool-output-61aab43d4f4f4f948f6193a5ef76ae28">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>{"final_status": "PASS", "message": "Query validated and safe to execute", "corrected_sql": "SELECT DISTINCT insight_type FROM `agent_insights`", "layers": {"llm_checker": {"status": "PASS", "detail": "LLM returned candidate SQL", "output": "SELECT DISTINCT insight_type FROM `agent_insights`"}, "static_checker": {"status": "PASS", "detail": "No modification detected", "output": "SELECT DISTINCT insight_type FROM `agent_insights`"}, "dry_run": {"status": "PASS", "detail": "Dry run succeeded", "output": "DRY_RUN_OK"}}}</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 4 â€” Calling tool: bigquery_query</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "SELECT DISTINCT insight_type FROM `agent_insights`"
}</pre>
                            </details>

                            <div id="tool-output-8f1b2b1b3c544d8d82752e2d0922f0fe">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>{
  "status": "SUCCESS",
  "executed_sql": "SELECT DISTINCT insight_type FROM `agent_insights`",
  "rows": [
    {
      "insight_type": "Governance Risk"
    },
    {
      "insight_type": "Usage Anomaly"
    },
    {
      "insight_type": "Resource Efficiency"
    },
    {
      "insight_type": "Data Quality Issue"
    },
    {
      "insight_type": "Policy Violation"
    },
    {
      "insight_type": "Cost Saving"
    },
    {
      "insight_type": "Security Risk"
    }
  ],
  "row_count": 7
}</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 5 â€” Calling tool: bq_unified_query_checker</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5"
}</pre>
                            </details>

                            <div id="tool-output-6a1b9e5c3f6f4f878a48ee343d41546d">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>{"final_status": "PASS", "message": "Query validated and safe to execute", "corrected_sql": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5", "layers": {"llm_checker": {"status": "PASS", "detail": "LLM returned candidate SQL", "output": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5"}, "static_checker": {"status": "PASS", "detail": "No modification detected", "output": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5"}, "dry_run": {"status": "PASS", "detail": "Dry run succeeded", "output": "DRY_RUN_OK"}}}</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 6 â€” Calling tool: bigquery_query</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5"
}</pre>
                            </details>

                            <div id="tool-output-1de58716bae14b8482eecb3d7493e719">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>{
  "status": "SUCCESS",
  "executed_sql": "SELECT insight_title, description, insight_type FROM `agent_insights` WHERE insight_type IN ('Governance Risk', 'Security Risk') LIMIT 5",
  "rows": [
    {
      "insight_title": "Concentrated 'Ghost Asset' Risk Under Managers",
      "description": "Specific managers oversee teams with a high number of devices that have not checked into the network in over 60 days. This concentration points to a systemic breakdown in asset stewardship within these teams, creating a significant security blind spot and increasing the risk of data breaches from lost or unmanaged devices. Engaging these few managers offers a targeted way to mitigate widespread asset loss.",
      "insight_type": "Security Risk"
    },
    {
      "insight_title": "Conflicting Device Records Across MDM Platforms",
      "description": "The same physical device, identified by its serial number, has conflicting data between the Mosyle and Intune management systems, such as different assigned users or OS versions. This data conflict corrupts compliance reports and obscures true asset ownership and security posture.",
      "insight_type": "Security Risk"
    },
    {
      "insight_title": "Prolonged Device Non-Compliance Impacts User Access",
      "description": "Over 10% of Windows devices remain in a 'NonCompliant' state for more than 7 consecutive days, as tracked across daily data ingestions. This extended non-compliance period indicates slow IT remediation and often results in restricted access to corporate resources, creating a direct and measurable drag on employee productivity.",
      "insight_type": "Security Risk"
    },
    {
      "insight_title": "Corporate-Purchased Devices Misclassified as Personal",
      "description": "Highlights devices recorded in Intune with an 'Personal' ownership type, despite evidence of a corporate purchase order for that model and user. This misclassification leads to lax security policies being applied, creating a compliance gap and security vulnerability.",
      "insight_type": "Governance Risk"
    },
    {
      "insight_title": "Corporate Devices Bypass Key Security Policies",
      "description": "A subset of corporate devices managed by Microsoft Intune are not correctly registered with Azure AD. This configuration failure represents a critical security gap, as these devices can bypass Conditional Access policies designed to protect company data. This allows devices that do not meet security standards to potentially access sensitive resources, undermining the organization's zero-trust security posture and increasing the risk of a data breach.",
      "insight_type": "Security Risk"
    }
  ],
  "row_count": 5
}</pre>
                                </details>
                            </div>
                        </div></div><div class="msg bot-msg"><iframe style="width: 100%; height: 500px; border: none;" src="./Q6_files/saved_resource.html"></iframe></div></div></div>

        <div class="chat-input-area">
            <input type="text" id="userInput" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // ðŸ”¥ NEW SESSION ID USING TIMESTAMP + HIGH PRECISION TIMER
        const sessionId = `${Date.now()}${performance.now().toFixed(3).replace('.', '')}`;
        console.log("Generated Session ID:", sessionId);

        // Maps step_id -> tool output div
        const stepOutputTargetMap = {};

        // Stores tool outputs that arrive early
        const pendingToolOutputs = {};

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const chatBox = document.getElementById("chatBox");
            const text = input.value.trim();
            if (!text) return;

            input.value = "";

            // --- WRAPPER for this message ---
            const requestWrapper = document.createElement("div");
            requestWrapper.className = "request-block";
            chatBox.appendChild(requestWrapper);

            // USER MESSAGE
            const userBubble = document.createElement("div");
            userBubble.className = "msg user-msg";
            userBubble.innerText = text;
            requestWrapper.appendChild(userBubble);

            // Steps container for this request
            const stepsContainer = document.createElement("div");
            stepsContainer.className = "msg bot-msg";
            stepsContainer.innerHTML = "<b>Agent Steps:</b><br>";
            requestWrapper.appendChild(stepsContainer);

            chatBox.scrollTop = chatBox.scrollHeight;

            // --- Streaming fetch ---
            const response = await fetch(
                `http://localhost:8000/db_agent?user_input=${encodeURIComponent(text)}&session_id=${sessionId}`
            );

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            let finalAnswer = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                if (!chunk) continue;

                chunk.split("\n").forEach(line => {
                    if (!line.trim()) return;

                    let data;
                    try { data = JSON.parse(line); }
                    catch { return; }

                    // -------------------------------------------------------
                    // TOOL CALL
                    // -------------------------------------------------------
                    if (data.type === "tool_call") {
                        const stepId = data.step_id;
                        const uniqueDivId = `tool-output-${stepId}`;
                        stepOutputTargetMap[stepId] = uniqueDivId;

                        const box = document.createElement("div");
                        box.innerHTML = `
                            <div><b>ðŸ”§ Step ${data.sequence} â€” Calling tool: ${data.tool_name}</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>${JSON.stringify(data.tool_input, null, 2)}</pre>
                            </details>

                            <div id="${uniqueDivId}"></div>
                        `;

                        stepsContainer.appendChild(box);

                        // Apply pending tool output if it arrived early
                        if (pendingToolOutputs[stepId]) {
                            const outBox = document.getElementById(uniqueDivId);
                            outBox.innerHTML = `
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>${pendingToolOutputs[stepId]}</pre>
                                </details>
                            `;
                            delete pendingToolOutputs[stepId];
                        }
                    }

                    // -------------------------------------------------------
                    // TOOL OUTPUT
                    // -------------------------------------------------------
                    if (data.type === "tool_output") {
                        const stepId = data.step_id;
                        const divId = stepOutputTargetMap[stepId];
                        const outputDiv = divId ? document.getElementById(divId) : null;

                        if (outputDiv) {
                            outputDiv.innerHTML = `
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>${data.content}</pre>
                                </details>
                            `;
                        } else {
                            // output arrived before its tool_call
                            pendingToolOutputs[stepId] = data.content;
                        }
                    }

                    // -------------------------------------------------------
                    // FINAL AI MESSAGE
                    // -------------------------------------------------------
                    if (data.type === "ai_message") {
                        finalAnswer = data.content;
                    }

                    // -------------------------------------------------------
                    // ERROR
                    // -------------------------------------------------------
                    if (data.error) {
                        const errDiv = document.createElement("div");
                        errDiv.className = "msg bot-msg";
                        errDiv.style.color = "red";
                        errDiv.innerText = `Error: ${data.error}`;
                        requestWrapper.appendChild(errDiv);
                    }
                });

                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // -------------------------------------------------------
            // RENDER FINAL ANSWER (inside THIS request block ONLY)
            // -------------------------------------------------------
            if (finalAnswer) {
            const finalDiv = document.createElement("div");
            finalDiv.className = "msg bot-msg";

            // Create iframe
            const iframe = document.createElement("iframe");
            iframe.style.width = "100%";
            iframe.style.height = "500px"; // adjust as needed
            iframe.style.border = "none";

            // Append iframe to finalDiv
            finalDiv.appendChild(iframe);   
            requestWrapper.appendChild(finalDiv);

            // Write the agent HTML into the iframe
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(finalAnswer); // the full HTML/CSS/JS output
            doc.close();
        }

            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>



</body></html>