<!DOCTYPE html>
<!-- saved from url=(0035)http://127.0.0.1:5500/frontend.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>DB Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f5;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 80%;
            height: 70%;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #4a77f7;
            padding: 16px;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .chat-box {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f7f9fc;
        }

        .msg {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.4;
            font-size: 14px;
        }

        .user-msg {
            background: #4a77f7;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .bot-msg {
            background: #e5e7eb;
            color: #111;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            display: flex;
            border-top: 1px solid #ddd;
        }

        input {
            flex: 1;
            padding: 12px;
            border: none;
            outline: none;
            font-size: 15px;
        }

        button {
            padding: 0 18px;
            background: #4a77f7;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #3b63d6;
        }

        .request-block {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="chat-container">
        <style>
            .chat-header {
                background-color: #4a77f7;
                color: #ffffff;
                padding: 12px 20px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 18px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                display: inline-block;
            }
            
            .chat-header .assistant-name {
                color: #f48a26; /* Highlight color for DB Assistant */
                font-weight: bold;
                font-size: 20px;
                margin-right: 6px;
            }
            </style>
            
            <div class="chat-header">
                <span class="assistant-name">DB Assistant</span> - Remember, even humans make mistakes !
            </div>
            

        <div class="chat-box" id="chatBox"><div class="request-block"><div class="msg user-msg">Which specific data quality_failures are the root cause for the insights listed in the missed_insights table</div><div class="msg bot-msg"><b>Agent Steps:</b><br><div>
                            <div><b>ðŸ”§ Step 1 â€” Calling tool: bigquery_list_tables</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{}</pre>
                            </details>

                            <div id="tool-output-2a56e16e9c2b45b0aa8e0ef9fd8be439">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>agent_insights: No description available.
available_columns: No description available.
catalog: No description available.
data_dictionary: No description available.
dim_employees: No description available.
dlpwork: No description available.
fact_assets: No description available.
insight_computation: No description available.
insights: No description available.
insights_computation: No description available.
intune_assets: Intune Asset Inventory snapshot of devices managed via MDM. 
itglue_assets: IT Glue Asset Inventory snapshot of Apple devices (macOS, iOS/iPadOS, tvOS) managed via MDM. 
itglue_consumables: Inventory of IT Glue consumables (e.g., toner, cables, peripherals) with vendor/PO details, cost/quantity.
metadata_summary: No description available.
missed_insights: No description available.
mosyle_assets: Mosyle Asset Inventory snapshot of Apple devices (macOS, iOS/iPadOS, tvOS) managed via MDM.
profiling: No description available.
profiling_summary: No description available.
quality: No description available.
quality_summary: No description available.
workday_employees: Employee snapshot dataset, one row per employee.</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 2 â€” Calling tool: bigquery_get_schema</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "table_names": [
    "missed_insights",
    "quality"
  ]
}</pre>
                            </details>

                            <div id="tool-output-1090abf8ba794deabf01fbe672c5a349">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>
Table: missed_insights
Schema:
insight_id (STRING) - No description available.
insight_title (STRING) - No description available.
table_name (STRING) - No description available.
missing_columns (STRING) - No description available.

Sample Rows:
[{'insight_id': 'mos_ast_itam_004', 'insight_title': 'Inactive &amp; Unused Devices', 'table_name': 'assets', 'missing_columns': 'asset_id,asset_name,model,user_email,last_check_in_timestamp,last_reboot_timestamp,last_cloud_backup_date,asset_type,status,is_current,archived'}, {'insight_id': 'hris_itam_001', 'insight_title': 'Ghost Contractor Detection (Shadow Workforce Cleanup)', 'table_name': 'assets', 'missing_columns': 'user_email,last_check_in_timestamp'}, {'insight_id': 'mos_ast_itam_005', 'insight_title': 'Review Assets with Anomalous Lifespans', 'table_name': 'assets', 'missing_columns': 'asset_id,asset_name,model,asset_type,in_service_date,decommission_date,status,is_current'}]

Table: quality
Schema:
rule_name (STRING) - No description available.
rule_column (STRING) - No description available.
rule_dimension (STRING) - No description available.
rule_description (STRING) - No description available.
pass_ratio (FLOAT) - No description available.
passed (BOOLEAN) - No description available.
null_count (INTEGER) - No description available.
passed_count (INTEGER) - No description available.
evaluated_count (INTEGER) - No description available.
failing_rows_query (STRING) - No description available.
overall_score (FLOAT) - No description available.
overall_passed (BOOLEAN) - No description available.
total_row_count (STRING) - No description available.
start_time (STRING) - No description available.
end_time (STRING) - No description available.
assertion_row_count (INTEGER) - No description available.
rule_threshold (FLOAT) - No description available.
rule_ignore_null (BOOLEAN) - No description available.
rule_suspended (BOOLEAN) - No description available.
rule_set_expectation_values (RECORD) - No description available.
rule_regex_expectation_regex (STRING) - No description available.
rule_sql_assertion_sql_statement (STRING) - No description available.
name (STRING) - No description available.
uid (STRING) - No description available.
state (STRING) - No description available.
type (INTEGER) - No description available.
create_time (STRING) - No description available.
sampling_percent (FLOAT) - No description available.
row_filter (STRING) - No description available.
tool_id (STRING) - No description available.
dataset (STRING) - No description available.
rule_range_expectation_min_value (STRING) - No description available.
rule_range_expectation_strict_min_enabled (BOOLEAN) - No description available.
rule_range_expectation_max_value (STRING) - No description available.
rule_range_expectation_strict_max_enabled (BOOLEAN) - No description available.

Sample Rows:
[{'rule_name': 'id-not-null-check', 'rule_column': 'asset_id', 'rule_dimension': 'COMPLETENESS', 'rule_description': 'ID must not be null (primary key)', 'pass_ratio': 1.0, 'passed': True, 'null_count': 0, 'passed_count': 1923, 'evaluated_count': 1923, 'failing_rows_query': 'WITH `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` AS (SELECT * FROM `ipdevelopment-dev-p01.astreya_staging.itglue_consumables` ) SELECT * FROM `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` WHERE (`id` IS NULL);', 'overall_score': 88.89, 'overall_passed': False, 'total_row_count': '1923', 'start_time': '2025-11-20T09:31:44.166Z', 'end_time': '2025-11-20T09:32:15.874817101Z', 'assertion_row_count': 0, 'rule_threshold': 1.0, 'rule_ignore_null': False, 'rule_suspended': False, 'rule_set_expectation_values': None, 'rule_regex_expectation_regex': None, 'rule_sql_assertion_sql_statement': None, 'name': 'projects/468286210290/locations/us-central1/dataScans/astreya-itglue-consumables-dq/jobs/7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'uid': '7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'state': 'SUCCEEDED', 'type': 1, 'create_time': '2025-11-20T09:31:43.626334516Z', 'sampling_percent': 100.0, 'row_filter': '', 'tool_id': 'itglue', 'dataset': 'consumables', 'rule_range_expectation_min_value': None, 'rule_range_expectation_strict_min_enabled': None, 'rule_range_expectation_max_value': None, 'rule_range_expectation_strict_max_enabled': None}, {'rule_name': 'item-type-not-null-check', 'rule_column': 'category', 'rule_dimension': 'COMPLETENESS', 'rule_description': 'Item type must not be null', 'pass_ratio': 1.0, 'passed': True, 'null_count': 0, 'passed_count': 1923, 'evaluated_count': 1923, 'failing_rows_query': 'WITH `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` AS (SELECT * FROM `ipdevelopment-dev-p01.astreya_staging.itglue_consumables` ) SELECT * FROM `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` WHERE (`item_type` IS NULL);', 'overall_score': 88.89, 'overall_passed': False, 'total_row_count': '1923', 'start_time': '2025-11-20T09:31:44.166Z', 'end_time': '2025-11-20T09:32:15.874817101Z', 'assertion_row_count': 0, 'rule_threshold': 0.95, 'rule_ignore_null': False, 'rule_suspended': False, 'rule_set_expectation_values': None, 'rule_regex_expectation_regex': None, 'rule_sql_assertion_sql_statement': None, 'name': 'projects/468286210290/locations/us-central1/dataScans/astreya-itglue-consumables-dq/jobs/7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'uid': '7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'state': 'SUCCEEDED', 'type': 1, 'create_time': '2025-11-20T09:31:43.626334516Z', 'sampling_percent': 100.0, 'row_filter': '', 'tool_id': 'itglue', 'dataset': 'consumables', 'rule_range_expectation_min_value': None, 'rule_range_expectation_strict_min_enabled': None, 'rule_range_expectation_max_value': None, 'rule_range_expectation_strict_max_enabled': None}, {'rule_name': 'description-not-null-check', 'rule_column': 'asset_description', 'rule_dimension': 'COMPLETENESS', 'rule_description': 'Description must not be null', 'pass_ratio': 1.0, 'passed': True, 'null_count': 0, 'passed_count': 1923, 'evaluated_count': 1923, 'failing_rows_query': 'WITH `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` AS (SELECT * FROM `ipdevelopment-dev-p01.astreya_staging.itglue_consumables` ) SELECT * FROM `7ef2fa9b-3a59-4a56-94e4-1bd50baa5037` WHERE (`description` IS NULL);', 'overall_score': 88.89, 'overall_passed': False, 'total_row_count': '1923', 'start_time': '2025-11-20T09:31:44.166Z', 'end_time': '2025-11-20T09:32:15.874817101Z', 'assertion_row_count': 0, 'rule_threshold': 0.9, 'rule_ignore_null': False, 'rule_suspended': False, 'rule_set_expectation_values': None, 'rule_regex_expectation_regex': None, 'rule_sql_assertion_sql_statement': None, 'name': 'projects/468286210290/locations/us-central1/dataScans/astreya-itglue-consumables-dq/jobs/7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'uid': '7ef2fa9b-3a59-4a56-94e4-1bd50baa5037', 'state': 'SUCCEEDED', 'type': 1, 'create_time': '2025-11-20T09:31:43.626334516Z', 'sampling_percent': 100.0, 'row_filter': '', 'tool_id': 'itglue', 'dataset': 'consumables', 'rule_range_expectation_min_value': None, 'rule_range_expectation_strict_min_enabled': None, 'rule_range_expectation_max_value': None, 'rule_range_expectation_strict_max_enabled': None}]</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 3 â€” Calling tool: bq_unified_query_checker</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "\nSELECT\n    t1.insight_title,\n    t2.rule_name,\n    t2.rule_column,\n    t2.rule_dimension,\n    t2.rule_description\n  FROM\n    `missed_insights` AS t1\n  CROSS JOIN\n    UNNEST(SPLIT(t1.missing_columns)) AS missing_column\n  INNER JOIN\n    `quality` AS t2\n  ON\n    t2.rule_column = missing_column\n"
}</pre>
                            </details>

                            <div id="tool-output-45a0fffd343a4de89ccbccd0c052c844">
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>{"final_status": "PASS", "message": "Query validated and safe to execute", "corrected_sql": "SELECT\n    t1.insight_title,\n    t2.rule_name,\n    t2.rule_column,\n    t2.rule_dimension,\n    t2.rule_description\n  FROM\n    `missed_insights` AS t1\n  CROSS JOIN\n    UNNEST(SPLIT(t1.missing_columns)) AS missing_column\n  INNER JOIN\n    `quality` AS t2\n  ON\n    t2.rule_column = missing_column", "layers": {"llm_checker": {"status": "PASS", "detail": "LLM returned candidate SQL", "output": "SELECT\n    t1.insight_title,\n    t2.rule_name,\n    t2.rule_column,\n    t2.rule_dimension,\n    t2.rule_description\n  FROM\n    `missed_insights` AS t1\n  CROSS JOIN\n    UNNEST(SPLIT(t1.missing_columns)) AS missing_column\n  INNER JOIN\n    `quality` AS t2\n  ON\n    t2.rule_column = missing_column"}, "static_checker": {"status": "PASS", "detail": "No modification detected", "output": "SELECT\n    t1.insight_title,\n    t2.rule_name,\n    t2.rule_column,\n    t2.rule_dimension,\n    t2.rule_description\n  FROM\n    `missed_insights` AS t1\n  CROSS JOIN\n    UNNEST(SPLIT(t1.missing_columns)) AS missing_column\n  INNER JOIN\n    `quality` AS t2\n  ON\n    t2.rule_column = missing_column"}, "dry_run": {"status": "PASS", "detail": "Dry run succeeded", "output": "DRY_RUN_OK"}}}</pre>
                                </details>
                            </div>
                        </div><div>
                            <div><b>ðŸ”§ Step 4 â€” Calling tool: bigquery_query</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>{
  "query": "SELECT\n    t1.insight_title,\n    t2.rule_name,\n    t2.rule_column,\n    t2.rule_dimension,\n    t2.rule_description\n  FROM\n    `missed_insights` AS t1\n  CROSS JOIN\n    UNNEST(SPLIT(t1.missing_columns)) AS missing_column\n  INNER JOIN\n    `quality` AS t2\n  ON\n    t2.rule_column = missing_column"
}</pre>
                            </details>

                            <div id="tool-output-45386945e3404f9e91d4a7c5bca9cdff"></div>
                        </div></div><div class="msg bot-msg"><iframe style="width: 100%; height: 500px; border: none;" src="./Q4_files/saved_resource.html"></iframe></div></div></div>

        <div class="chat-input-area">
            <input type="text" id="userInput" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // ðŸ”¥ NEW SESSION ID USING TIMESTAMP + HIGH PRECISION TIMER
        const sessionId = `${Date.now()}${performance.now().toFixed(3).replace('.', '')}`;
        console.log("Generated Session ID:", sessionId);

        // Maps step_id -> tool output div
        const stepOutputTargetMap = {};

        // Stores tool outputs that arrive early
        const pendingToolOutputs = {};

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const chatBox = document.getElementById("chatBox");
            const text = input.value.trim();
            if (!text) return;

            input.value = "";

            // --- WRAPPER for this message ---
            const requestWrapper = document.createElement("div");
            requestWrapper.className = "request-block";
            chatBox.appendChild(requestWrapper);

            // USER MESSAGE
            const userBubble = document.createElement("div");
            userBubble.className = "msg user-msg";
            userBubble.innerText = text;
            requestWrapper.appendChild(userBubble);

            // Steps container for this request
            const stepsContainer = document.createElement("div");
            stepsContainer.className = "msg bot-msg";
            stepsContainer.innerHTML = "<b>Agent Steps:</b><br>";
            requestWrapper.appendChild(stepsContainer);

            chatBox.scrollTop = chatBox.scrollHeight;

            // --- Streaming fetch ---
            const response = await fetch(
                `http://localhost:8000/db_agent?user_input=${encodeURIComponent(text)}&session_id=${sessionId}`
            );

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            let finalAnswer = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                if (!chunk) continue;

                chunk.split("\n").forEach(line => {
                    if (!line.trim()) return;

                    let data;
                    try { data = JSON.parse(line); }
                    catch { return; }

                    // -------------------------------------------------------
                    // TOOL CALL
                    // -------------------------------------------------------
                    if (data.type === "tool_call") {
                        const stepId = data.step_id;
                        const uniqueDivId = `tool-output-${stepId}`;
                        stepOutputTargetMap[stepId] = uniqueDivId;

                        const box = document.createElement("div");
                        box.innerHTML = `
                            <div><b>ðŸ”§ Step ${data.sequence} â€” Calling tool: ${data.tool_name}</b></div>

                            <details>
                                <summary>ðŸ“¥ Tool Input</summary>
                                <pre>${JSON.stringify(data.tool_input, null, 2)}</pre>
                            </details>

                            <div id="${uniqueDivId}"></div>
                        `;

                        stepsContainer.appendChild(box);

                        // Apply pending tool output if it arrived early
                        if (pendingToolOutputs[stepId]) {
                            const outBox = document.getElementById(uniqueDivId);
                            outBox.innerHTML = `
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>${pendingToolOutputs[stepId]}</pre>
                                </details>
                            `;
                            delete pendingToolOutputs[stepId];
                        }
                    }

                    // -------------------------------------------------------
                    // TOOL OUTPUT
                    // -------------------------------------------------------
                    if (data.type === "tool_output") {
                        const stepId = data.step_id;
                        const divId = stepOutputTargetMap[stepId];
                        const outputDiv = divId ? document.getElementById(divId) : null;

                        if (outputDiv) {
                            outputDiv.innerHTML = `
                                <details>
                                    <summary>ðŸ“„ Tool Output</summary>
                                    <pre>${data.content}</pre>
                                </details>
                            `;
                        } else {
                            // output arrived before its tool_call
                            pendingToolOutputs[stepId] = data.content;
                        }
                    }

                    // -------------------------------------------------------
                    // FINAL AI MESSAGE
                    // -------------------------------------------------------
                    if (data.type === "ai_message") {
                        finalAnswer = data.content;
                    }

                    // -------------------------------------------------------
                    // ERROR
                    // -------------------------------------------------------
                    if (data.error) {
                        const errDiv = document.createElement("div");
                        errDiv.className = "msg bot-msg";
                        errDiv.style.color = "red";
                        errDiv.innerText = `Error: ${data.error}`;
                        requestWrapper.appendChild(errDiv);
                    }
                });

                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // -------------------------------------------------------
            // RENDER FINAL ANSWER (inside THIS request block ONLY)
            // -------------------------------------------------------
            if (finalAnswer) {
            const finalDiv = document.createElement("div");
            finalDiv.className = "msg bot-msg";

            // Create iframe
            const iframe = document.createElement("iframe");
            iframe.style.width = "100%";
            iframe.style.height = "500px"; // adjust as needed
            iframe.style.border = "none";

            // Append iframe to finalDiv
            finalDiv.appendChild(iframe);   
            requestWrapper.appendChild(finalDiv);

            // Write the agent HTML into the iframe
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(finalAnswer); // the full HTML/CSS/JS output
            doc.close();
        }

            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>



</body></html>